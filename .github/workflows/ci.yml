name: Ash & Oil CI

on:
  push:
    branches: [ master, main ]
  pull_request:
    branches: [ master, main ]

jobs:
  # ── Job 1: JSON syntax + data integrity ───────────────────────────────────
  validate-data:
    name: Data Integrity (Python)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"
      - name: Check all JSON files parse
        run: |
          for f in data/*.json; do
            echo "Checking $f..."
            python -c "import json,sys; json.load(open('$f', encoding='utf-8'))" || exit 1
          done
          echo "All JSON files valid."
      - name: Run data integrity suite
        run: python -X utf8 tests/validate_data.py

  # ── Job 2: GDScript lint ───────────────────────────────────────────────────
  lint-gdscript:
    name: GDScript Lint (gdtoolkit)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"
      - name: Install gdtoolkit
        run: pip install "gdtoolkit==4.*"
      - name: Lint autoload scripts
        run: find scripts/autoload -name "*.gd" -exec gdlint {} \; || exit 1
      - name: Lint UI scripts
        run: find scripts/ui -name "*.gd" -exec gdlint {} \; || exit 1
      - name: Lint test runner
        run: find tests/runner -name "*.gd" -exec gdlint {} \; || exit 1

  # ── Job 3: Test suite structure validation ────────────────────────────────
  validate-tests:
    name: Test Suite Structure
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"
      - name: Verify all test files exist
        run: |
          python -c "
          import os, sys
          required = [
            'tests/runner/TestBase.gd',
            'tests/runner/TestRunner.gd',
            'tests/unit/test_gamestate.gd',
            'tests/unit/test_cardmanager.gd',
            'tests/unit/test_missionmanager.gd',
            'tests/unit/test_savemanager.gd',
            'tests/unit/test_combat_logic.gd',
            'tests/integration/test_mission_flow.gd',
            'tests/integration/test_save_load.gd',
          ]
          missing = [f for f in required if not os.path.exists(f)]
          if missing:
            [print('MISSING: ' + f) for f in missing]
            sys.exit(1)
          print(f'All {len(required)} test files present.')
          "
      - name: Count test methods (must be 50+)
        run: |
          python -c "
          import os, re, sys
          total = 0
          for root, dirs, files in os.walk('tests'):
            dirs[:] = [d for d in dirs if d != 'runner']
            for fname in files:
              if fname.startswith('test_') and fname.endswith('.gd'):
                content = open(os.path.join(root, fname)).read()
                methods = re.findall(r'^func (test_\w+)', content, re.MULTILINE)
                total += len(methods)
                print(f'  {fname}: {len(methods)} tests')
          print(f'Total: {total} tests')
          if total < 50: sys.exit(1)
          "
      - name: Verify all tests extend TestBase
        run: |
          python -c "
          import os, sys
          bad = []
          for root, dirs, files in os.walk('tests'):
            dirs[:] = [d for d in dirs if d != 'runner']
            for fname in files:
              if fname.startswith('test_') and fname.endswith('.gd'):
                path = os.path.join(root, fname)
                if 'extends \"res://tests/runner/TestBase.gd\"' not in open(path).read():
                  bad.append(path)
          if bad:
            [print('Missing TestBase: ' + f) for f in bad]
            sys.exit(1)
          print('All test suites extend TestBase.')
          "

  # ── Job 4: Data cross-reference integrity ─────────────────────────────────
  validate-crossrefs:
    name: Data Cross-References
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"
      - name: Enemy IDs in missions exist in enemy_templates
        run: |
          python -c "
          import json, sys
          missions = json.load(open('data/missions.json', encoding='utf-8'))
          enemies  = json.load(open('data/enemy_templates.json', encoding='utf-8'))
          bad = [f'{mid} -> {eid}' for mid,m in missions.items() for eid in m.get('enemies',[]) if eid not in enemies]
          if bad: [print('BAD: '+b) for b in bad]; sys.exit(1)
          print(f'All mission enemy refs valid.')
          "
      - name: Starter deck cards all exist
        run: |
          python -c "
          import json, sys
          cards = json.load(open('data/cards.json', encoding='utf-8'))
          starter = ['card_027']*4 + ['card_001']*4 + ['card_028']*3 + ['card_002']*3 + ['card_029']*3 + ['card_033']*2
          bad = list(set(c for c in starter if c not in cards))
          if bad: [print('MISSING: '+b) for b in bad]; sys.exit(1)
          print(f'All {len(starter)} starter deck cards valid.')
          "
      - name: Lieutenant card refs exist
        run: |
          python -c "
          import json, sys
          cards = json.load(open('data/cards.json', encoding='utf-8'))
          lts   = json.load(open('data/lieutenants.json', encoding='utf-8'))
          bad = [f'{n} -> {c}' for n,lt in lts.items() for c in lt.get('cards',[]) if c not in cards]
          if bad: [print('BAD: '+b) for b in bad]; sys.exit(1)
          print('All lieutenant card refs valid.')
          "
      - name: Meter names in missions are valid
        run: |
          python -c "
          import json, sys
          valid = {'RENOWN','HEAT','PIETY','FAVOR','DEBT','DREAD'}
          missions = json.load(open('data/missions.json', encoding='utf-8'))
          bad = [f'{mid}.{m}' for mid,mission in missions.items() for m in mission.get('meter_changes',{}) if m not in valid]
          if bad: [print('BAD: '+b) for b in bad]; sys.exit(1)
          print('All meter names valid.')
          "
