# IMPLEMENTATION DIRECTIVE — Dynamic Story + Quest System (RFQE v0.1) — LOCKED

## Goal
Implement a dynamic story + quest system where the player grows attached to their team. Quests and dialogue must create meaningful consequences (relationships, vows, debt, rivalry), not just progression. The system must support:
- A fixed main quest spine (Acts I–III)
- A procedural/reactionary contract layer
- 4 distinct endings (expandable)
- Final boss behavior that changes based on hidden party state

IMPORTANT: Relationship meters (Trust/Bond) are **HIDDEN** from the player. The player learns state from:
- party barks + dialogue event outcomes
- terminal “receipts” logs
- behavior changes (assists, hesitations, refusal, grief, etc.)

No patented “Nemesis System” replication. We use our own Rival Heat + Vengeance Clock + targeted intrusions.

---

## 1) DATA MODEL (STATE)

### 1.1 Global Campaign State
Maintain these values (persisted in save):
- renown: 0–100
- infamy: 0–100
- favor: { AEGIS: -50..+50, ECLIPSE: -50..+50, SPECTER: -50..+50 }
- debt: { gold: 0..∞, blood: 0..∞ }  // blood debt is “owed cost” flags
- receiptsLog: array of short strings (timestamped)

### 1.2 Party State (per teammate)
Each teammate has:
- id, name
- traits: [traitA, traitB]  // from a small pool (see below)
- need: one of [Respect, Safety, Profit, Control, Redemption, Glory]
- stress: 0–10
- trustToPlayer: 0–20   (HIDDEN)
- injuryTags: []        // existing injury system tags integrate here
- historyTags: []       // small strings, see below
- active: bool (in current party / alive)

### 1.3 Pairwise Relationship State
For each active pair (A,B):
- bond: 0–20 (HIDDEN)
- pairTags: [] (optional, can store in historyTags instead)

### 1.4 Rival State
- rivalId (or multiple later)
- hateLevel: 1–5
- vengeanceClock: 0–6
- targetTeammateId (can be null; choose dynamically)
- rivalHeat: 0–100 (computed or stored)
- rivalFlags: [] (e.g., humiliated, spared, escaped)

---

## 2) TAGS + TRAITS (MINIMUM SET)

### 2.1 Traits (starter pool: 8)
Protective, Reckless, Greedy, Stoic, Vengeful, MercyProne, Suspicious, Proud

### 2.2 Needs (starter pool: 6)
Respect, Safety, Profit, Control, Redemption, Glory

### 2.3 History Tags (keep active tags small; prefer these)
saved_me, left_me, took_hit_for_me, stole_credit,
split_loot, denied_relief,
kept_promise, broke_vow,
witnessed_mercy, witnessed_cruelty,
blood_debt, medical_debt,
rival_targeted_me, grief

RULE: avoid tag explosion; prefer reusing this set.

---

## 3) RELATIONSHIP RULES (HIDDEN METERS, VISIBLE EFFECTS)

### 3.1 Bond Changes (A<->B)
Bond increases:
- A protects/heals/shields B (+1)
- A shares resources with B (+1)
- Event choice supports B (+1 to +2)
Bond decreases:
- A abandons B / preventable injury occurs to B (−2)
- A denies relief to B while stressed/injured (−1)
- Event choice blames B (−2)

### 3.2 Trust Changes (Teammate -> Player)
Trust increases:
- Player keeps a vow (+2)
- Player fulfills teammate Need (+1 to +3)
- Player chooses safety over profit at meaningful times (+1)
Trust decreases:
- Player breaks vow (−3)
- Player sacrifices teammate for debt/reward (−3 to −5)
- Player repeatedly ignores injuries/stress (−1 per occurrence)

### 3.3 Stress
Stress increases:
- injuries, near-death, debt pressure, losses (+1..+3)
Stress decreases:
- rest choices, success, “support events” (−1..−3)

### 3.4 Silence Rules (UI/Dialogue)
Stress controls chatter frequency:
- 0–3: normal barks
- 4–6: shorter guarded barks
- 7–10: minimal barks; terminal logs carry tone (silence weapon)

---

## 4) VOWS SYSTEM (PROMISES THAT MATTER)

A Vow is a boolean flag created by certain dialogue choices.
Examples:
- vow_no_sacrifice
- vow_share_loot
- vow_no_retreat

Mechanics:
- Keeping a vow: add kept_promise tag; +Trust; add a positive receipt
- Breaking a vow: add broke_vow tag; −Trust; +Stress; add a “receipt” that is referenced later

Vows must be readable by Ending Resolver + Final Boss variants.

---

## 5) EVENT DECK SYSTEM (DYNAMIC DIALOGUE ENGINE)

### 5.1 Event Types (v0.1 minimum)
- BondEvent (two teammates; bond threshold or recent tag)
- LoyaltyTest (one teammate; need/trust/stress driven)
- CampArgument (stress driven; creates tags)
- InjuryFallout (injury tag triggers narrative scar + choice)
- RivalIntrusion (rival heat triggers sabotage; targets relationships)

### 5.2 Event Format
Each event is a data object:
- id, type
- conditions (thresholds/tags/state)
- promptText (terminal voice; short)
- choices: 2–3
  - each choice applies: meter deltas + tags + vow set/break + receipts lines

### 5.3 Event Frequency Control
Per expedition:
- Guarantee at least 1 event
- Cap at 2 events
Choose events based on highest-weight conditions to prevent randomness feeling aimless.

---

## 6) QUEST SYSTEM (MAIN SPINE + PROCEDURAL LAYER)

### 6.1 Main Quest Spine (Fixed)
- 3 Acts, ~15 core missions total
- These are authored milestones (bosses, reveals, setpieces)
- Progress unlocks by completing required core missions
- Main missions can read party state to swap dialogue, modifiers, intrusions

### 6.2 Procedural Contracts (Reactive)
Between main missions:
- Generate 2–4 contracts
- Player must complete at least 1 to advance
- Others expire/disappear
Contracts are generated from:
- renown/infamy/favor/debt
- party injuries/stress/trust distribution/bond tensions (hidden but computed)
- rival state

Procedural contracts must produce at least 2 of:
- stress shift
- bond/trust opportunity
- debt relief or debt trap
- rival escalation
- scar risk / injury pressure

---



### 6.3 Hooks Bridge (Consequences That Persist)

Procedural contracts are driven by the Contract Board Hook system.

Hook rules (must match Contract Board spec):
- Hooks are generated after every expedition in a post-expedition pass.
- Hooks represent unresolved consequences (injury, trust fractures, supply/debt pressure, rival targeting).
- Each hub visit must offer at least 2 contracts that can directly resolve active hooks.
- Unresolved hooks escalate (0–3). Escalation increases risk, applies penalties, and can force resolver contracts/events.

Story integration:
- Dialogue/Event Deck choices are allowed to CREATE hooks directly (not just meter deltas).
- Any event outcome that sets tags like broke_vow, denied_relief, split_loot, rival_targeted_me, or creates/advances debt MUST create or update the corresponding hook:
  - broke_vow => vow_broken:vowType (+ optional trust_drop:teammateId)
  - denied_relief / preventable injury => bond_fracture:A,B or trust_drop:teammateId
  - debt bargain => debt_pressure (or convert to blood_debt meta)
  - rival sabotage => rival_targets:teammateId (or rival_heat_spike meta)

Hook generation mapping (minimum triggers; details live in Contract Board doc):
- injury_minor / injury_major: created from injury tiers and minor-stacks after expedition.
- low_supplies: created when supplies cross “low/critical.”
- debt_pressure: created when debt crosses band thresholds or interest ticks.
- bond_fracture / trust_drop / vow_created / vow_broken / grief_active: created from event tags and meter threshold events.
- rival_targets: created when rival target changes or intrusion attempt happens.

IMPORTANT:
- Trust/Bond remain hidden; hooks are the player-facing consequence layer via contracts, risk tags, and terminal receipts.
- Endings + Final Boss variants can read hook history (createdAt, ignoredCount, escalationLevel peaks) as “evidence” even after a hook resolves.

---

## 7) ENDINGS (4, EXPANDABLE)

Compute end-state variables at finale:

### 7.1 Metrics (normalized 0–100 except FA)
- LI (Loyalty Index): average trustToPlayer across active party scaled to 0–100
- CI (Cohesion Index): average of top 3 pairwise bonds scaled to 0–100
- DB (Debt Burden): 0–100 derived from debt.gold + debt.blood + blood_debt/medical_debt tags
- RH (Rival Heat): 0–100 from hateLevel, vengeanceClock, rivalFlags, recent intrusions
- FA (Faction Alignment): which faction has highest favor and its magnitude

### 7.2 Resolution Priority (IMPORTANT)
Resolve ending in this order:
1) Blood Ledger if DB >= 70
2) Mutiny if LI <= 35 AND DB < 70
3) Liberation if LI >= 65 AND CI >= 55 AND DB < 50
4) Crown otherwise

Endings:
- Liberation: break the circuit / revolt / escape with proof
- Crown: win but become an owned “champion asset”
- Blood Ledger: system collects (forced permanent scar / collateral / vow-break)
- Mutiny: team deserts/refuses/turns mid-finale

EXPANDABLE: new endings can be inserted between steps 2–4 later.

---

## 8) FINAL BOSS VARIANT MATRIX (C)

One boss identity, 3 phases, each phase picks 1 variant module based on metrics:

### Phase 1 (Social Pressure) — driven by LI/CI
- Variant: CORRUPTION if CI high (temptations, tradeoffs)
- Variant: DISCORD if CI low (assists fail, buffs don’t share, argument triggers)

### Phase 2 (Resource Pressure) — driven by DB/FA
- Variant: LIEN if DB high (collect at HP thresholds: lock healing / force scar choice / seize reward)
- Variant: ESCALATION if DB normal (adds/hazards)
- Optional overlay: FA “help-with-a-cost” injection (buff now, consequence later)

### Phase 3 (Betrayal/Rival Pressure) — driven by RH/LI
- Variant: RIVAL_ENTRY if RH high (rival add replaces a boss mechanic; targets most emotionally relevant teammate)
- Variant: BETRAYAL_CHECK if LI low (lowest-trust teammate hesitates/refuses/temporarily flips for 1 wave)
- Variant: UNITY_TEST if LI high (team can trigger coordinated action if they remain aligned)

Boss behavior changes must be visible through gameplay + dialogue, not a UI meter.

---

## 9) PRESENTATION (HIDDEN METERS)
Do NOT show Trust/Bond numbers.
Instead show:
- short barks that reference tags (“After the bunker… you still trust me?”)
- terminal receipts logs (“RECEIPT: You promised no one would bleed for debt. Timestamp: …”)
- behavioral tells (assist chance, hesitation, refusal, grief reaction)

---

## 10) DELIVERABLES TO IMPLEMENT (v0.1)
1) Data structures + save/load integration
2) Event deck runner:
   - condition evaluation
   - weighted selection
   - apply outcomes
   - receipts logging
3) Procedural contract generator:
   - uses state inputs
   - outputs 2–4 contracts
4) Ending Resolver using the priority rules
5) Final boss phase variant selection + hooks
6) Minimal content pack:
   - 12 events (4 bond, 3 loyalty, 3 argument, 2 injury fallout)
   - 12 procedural contract templates
   - 15 mission spine stubs (names + triggers; dialogue can be placeholder)

All systems must be modular and not overwrite unrelated game logic.
